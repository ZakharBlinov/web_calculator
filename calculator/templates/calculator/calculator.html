{% extends 'calculator/base.html' %}

{% block content %}
<div class="calculator-container">
    <h1>Калькулятор</h1>
    
    <div class="auth-info">
        {% if not user.is_authenticated %}
        <div class="auth-warning" id="auth-warning">
            <p>⚠️ Для сохранения истории операций необходимо <a href="#" onclick="showLogin()">войти</a> или <a href="#" onclick="showRegister()">зарегистрироваться</a></p>
        </div>
        {% endif %}
    </div>
    
    <div class="calculator-form">
        <div class="input-group">
            <input type="text" id="num1" placeholder="Первое число" class="number-input">
            <select id="operation" class="operation-select">
                <option value="add">Сложение (+)</option>
                <option value="subtract">Вычитание (-)</option>
                <option value="multiply">Умножение (*)</option>
                <option value="divide">Деление (/)</option>
                <option value="power">Возведение в степень (^)</option>
                <option value="sqrt">Квадратный корень (√)</option>
            </select>
            <input type="text" id="num2" placeholder="Второе число" class="number-input">
        </div>
        
        <div class="buttons">
            <button onclick="calculate()" class="btn-calculate">Вычислить</button>
            <button onclick="clearInputs()" class="btn-clear">Очистить</button>
        </div>
    </div>

    <div class="result-container">
        <h2>Результат:</h2>
        <div id="result" class="result-display">
            Введите числа и выберите операцию
        </div>
        <div id="error" class="error-message"></div>
    </div>

    <div class="instructions">
        <h3>Инструкция:</h3>
        <ul>
            <li>Введите числа в поля ввода</li>
            <li>Выберите операцию из выпадающего списка</li>
            <li>Для квадратного корня используйте только первое поле</li>
            <li>Поддерживаются дробные числа (через точку)</li>
            <li>При авторизации все вычисления сохраняются в вашей истории</li>
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    updateOperationField();
});

function validateInput(value) {
    if (value === '') return true;
    const regex = /^-?\d*\.?\d+$/;
    return regex.test(value);
}

async function calculate() {
    const num1 = document.getElementById('num1').value;
    const num2 = document.getElementById('num2').value;
    const operation = document.getElementById('operation').value;
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    
    resultDiv.innerHTML = '<div class="calculating">Вычисление...</div>';
    errorDiv.textContent = '';
    errorDiv.classList.remove('show');
    
    if (!validateInput(num1)) {
        showError('Первое число содержит недопустимые символы');
        return;
    }
    
    if (operation !== 'sqrt' && !validateInput(num2)) {
        showError('Второе число содержит недопустимые символы');
        return;
    }
    
    if (num1 === '' || (operation !== 'sqrt' && num2 === '')) {
        showError('Заполните все поля');
        return;
    }
    
    try {
        const data = await performCalculation(num1, num2, operation);
        
        resultDiv.innerHTML = `
            <div class="result-success">
                <div class="expression">${data.calculation.expression}</div>
                <div class="equals">=</div>
                <div class="final-result">${data.result}</div>
                <div class="saved-info">✅ Результат сохранен в истории</div>
            </div>
        `;
        resultDiv.classList.add('success');
        
        setTimeout(() => {
            resultDiv.classList.remove('success');
        }, 2000);
        
    } catch (error) {
        if (error.message === 'Требуется авторизация' || error.message.includes('CSRF ошибка')) {
            showError(error.message);
            showLogin();
        } else {
            showError(error.message);
        }
    }
}

function clearInputs() {
    document.getElementById('num1').value = '';
    document.getElementById('num2').value = '';
    document.getElementById('result').innerHTML = 'Введите числа и выберите операцию';
    document.getElementById('error').textContent = '';
    document.getElementById('error').classList.remove('show');
}

function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.classList.add('show');
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = 'Произошла ошибка';
}

function updateOperationField() {
    const operation = document.getElementById('operation').value;
    const num2Input = document.getElementById('num2');
    if (operation === 'sqrt') {
        num2Input.disabled = true;
        num2Input.placeholder = 'Не требуется';
        num2Input.value = '';
    } else {
        num2Input.disabled = false;
        num2Input.placeholder = 'Второе число';
    }
}

document.getElementById('operation').addEventListener('change', updateOperationField);

document.getElementById('num1').addEventListener('input', function() {
    if (!validateInput(this.value) && this.value !== '') {
        this.classList.add('invalid');
    } else {
        this.classList.remove('invalid');
    }
});

document.getElementById('num2').addEventListener('input', function() {
    if (!validateInput(this.value) && this.value !== '') {
        this.classList.add('invalid');
    } else {
        this.classList.remove('invalid');
    }
});
</script>

<style>
.result-success {
    text-align: center;
    padding: 20px;
}

.expression {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 10px;
}

.equals {
    font-size: 1.2rem;
    color: #666;
    margin: 5px 0;
}

.final-result {
    font-size: 2.5rem;
    font-weight: bold;
    color: #4cd964;
    margin: 10px 0;
}

.saved-info {
    font-size: 0.9rem;
    color: #667eea;
    margin-top: 10px;
    font-style: italic;
}

.calculating {
    text-align: center;
    color: #667eea;
    font-style: italic;
}

.number-input.invalid {
    border-color: #ff4757;
    background-color: rgba(255, 71, 87, 0.05);
}

.auth-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 12px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.auth-warning a {
    color: #667eea;
    text-decoration: none;
    font-weight: bold;
}

.auth-warning a:hover {
    text-decoration: underline;
}
</style>
{% endblock %}