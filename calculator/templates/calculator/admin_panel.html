{% extends 'calculator/base.html' %}

{% block content %}
<div class="admin-container">
    <h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
    
    {% if user.is_authenticated and user.is_staff %}
    <div class="admin-stats" id="admin-stats"></div>
    
    <div class="admin-controls">
        <div class="user-filters">
            <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
            <input type="number" id="user-id" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <select id="operation-filter">
                <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
                <option value="add">–°–ª–æ–∂–µ–Ω–∏–µ</option>
                <option value="subtract">–í—ã—á–∏—Ç–∞–Ω–∏–µ</option>
                <option value="multiply">–£–º–Ω–æ–∂–µ–Ω–∏–µ</option>
                <option value="divide">–î–µ–ª–µ–Ω–∏–µ</option>
                <option value="power">–°—Ç–µ–ø–µ–Ω—å</option>
                <option value="sqrt">–ö–æ—Ä–µ–Ω—å</option>
            </select>
            <button onclick="loadAdminCalculations()" class="btn-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        
        <div class="admin-actions">
            <button onclick="clearAllHistory()" class="btn-clear-all">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
    </div>
    
    <div class="admin-table-container">
        <table class="admin-table" id="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–í—ã—Ä–∞–∂–µ–Ω–∏–µ</th>
                    <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="admin-table-body">
                <tr>
                    <td colspan="7" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination" id="pagination"></div>
    
    {% else %}
    <div class="access-denied">
        <h2>‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
        <p>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
        <p>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>{{ user.username|default:"–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω" }}</strong></p>
        <p>–°—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: <strong>{{ user.is_staff|yesno:"–î–∞,–ù–µ—Ç" }}</strong></p>
        
        {% if user.is_authenticated %}
        <div class="suggestions">
            <p>–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:</p>
            <ul>
                <li>–í—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ –ø–æ–¥ —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å—å—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</li>
                <li>–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</li>
                <li>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å Django</li>
            </ul>
        </div>
        
        <div class="admin-commands">
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</h3>
            <pre>
# –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
python manage.py createsuperuser
# –ò–ª–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
python manage.py shell
from django.contrib.auth.models import User
user = User.objects.get(username='–í–ê–®–ï_–ò–ú–Ø')
user.is_staff = True
user.is_superuser = True
user.save()
            </pre>
        </div>
        {% else %}
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="#" onclick="showLogin()">–≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É</a>.</p>
        {% endif %}
        
        <div class="navigation-links">
            <a href="/calculator/" class="btn-back">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É</a>
            <a href="/admin/" class="btn-django-admin">Django Admin</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (currentUser && currentUser.is_staff) {
        loadAdminCalculations();
        loadAdminStatistics();
    } else {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º');
    }
});

async function loadAdminCalculations() {
    if (!currentUser || !currentUser.is_staff) {
        showMessage('–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', true);
        return;
    }
    
    try {
        const search = document.getElementById('user-search').value;
        const userId = document.getElementById('user-id').value;
        const operation = document.getElementById('operation-filter').value;
        
        let url = '/calculator/api/admin/calculations/?ordering=-created_at';
        
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }
        
        if (userId) {
            url += `&user_id=${userId}`;
        }
        
        if (operation) {
            url += `&operation=${operation}`;
        }
        
        const response = await fetch(url, {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            renderAdminTable(data.results || data);
        } else if (response.status === 403) {
            showMessage('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', true);
        } else {
            const errorData = await response.json();
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (errorData.detail || response.status), true);
        }
    } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, true);
    }
}

function renderAdminTable(calculations) {
    const tbody = document.getElementById('admin-table-body');
    
    if (!calculations || calculations.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    calculations.forEach(calc => {
        const date = new Date(calc.created_at);
        const formattedDate = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        html += `
            <tr data-id="${calc.id}">
                <td>${calc.id}</td>
                <td>
                    <div class="user-cell">
                        <div class="username">${calc.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                        <div class="user-id">ID: ${calc.user}</div>
                    </div>
                </td>
                <td>${calc.expression}</td>
                <td><strong>${calc.result}</strong></td>
                <td>
                    <span class="operation-badge ${calc.operation}">
                        ${calc.operation_display}
                    </span>
                </td>
                <td>${formattedDate}</td>
                <td>
                    <button onclick="adminDeleteCalculation(${calc.id})" class="btn-delete" title="–£–¥–∞–ª–∏—Ç—å">
                        üóëÔ∏è
                    </button>
                    <button onclick="adminViewDetails(${calc.id})" class="btn-view" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                        üëÅÔ∏è
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

async function loadAdminStatistics() {
    if (!currentUser || !currentUser.is_staff) return;
    
    try {
        const response = await fetch('/calculator/api/statistics/', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            const statsDiv = document.getElementById('admin-stats');
            
            let html = '<div class="admin-stats-container">';
            html += `<div class="stat-card total"><h3>${data.total_calculations}</h3><p>–í—Å–µ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π</p></div>`;
            
            if (data.recent_calculations && data.recent_calculations.length > 0) {
                html += `<div class="stat-card recent"><h3>${data.recent_calculations.length}</h3><p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</p></div>`;
            }
            
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º
            const operationCounts = {};
            if (data.recent_calculations) {
                data.recent_calculations.forEach(calc => {
                    operationCounts[calc.operation] = (operationCounts[calc.operation] || 0) + 1;
                });
                
                Object.entries(operationCounts).forEach(([op, count]) => {
                    const opNames = {
                        'add': '‚ûï',
                        'subtract': '‚ûñ',
                        'multiply': '‚úñÔ∏è',
                        'divide': '‚ûó',
                        'power': 'üî¢',
                        'sqrt': '‚àö'
                    };
                    html += `<div class="stat-card"><h3>${count}</h3><p>${opNames[op] || op}</p></div>`;
                });
            }
            
            html += '</div>';
            statsDiv.innerHTML = html;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    }
}

async function adminDeleteCalculation(id) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    try {
        const csrfToken = getCSRFToken();
        const response = await fetch(`/calculator/api/calculations/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'include'
        });
        
        if (response.ok) {
            showMessage('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
            loadAdminCalculations();
        } else if (response.status === 403) {
            showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏', true);
        } else {
            const errorData = await response.json();
            showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (errorData.detail || response.status), true);
        }
    } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, true);
    }
}

async function clearAllHistory() {
    if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï: –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    try {
        const csrfToken = getCSRFToken();
        const response = await fetch('/calculator/api/clear-history/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ all_users: true }),
            credentials: 'include'
        });
        
        if (response.ok) {
            showMessage('–í—Å—è –∏—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
            loadAdminCalculations();
        } else if (response.status === 403) {
            showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏', true);
        } else {
            const errorData = await response.json();
            showMessage('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ' + (errorData.detail || response.status), true);
        }
    } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, true);
    }
}

function adminViewDetails(id) {
    showMessage(`–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–∏ ID: ${id}. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ.`);
}

function showMessage(message, isError = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = isError ? 'flash-message error' : 'flash-message';
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}
</script>

<style>
.admin-container {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}

.access-denied {
    text-align: center;
    padding: 40px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 10px;
    color: #856404;
}

.access-denied h2 {
    color: #856404;
    margin-bottom: 20px;
}

.suggestions {
    text-align: left;
    margin: 20px 0;
    padding: 15px;
    background: white;
    border-radius: 5px;
}

.suggestions ul {
    text-align: left;
    margin-left: 20px;
}

.admin-commands {
    text-align: left;
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
    font-family: monospace;
    font-size: 12px;
    overflow-x: auto;
}

.navigation-links {
    margin-top: 30px;
    display: flex;
    gap: 15px;
    justify-content: center;
}

.btn-back, .btn-django-admin {
    padding: 10px 20px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-back {
    background: #667eea;
    color: white;
}

.btn-django-admin {
    background: #4cd964;
    color: white;
}

.btn-back:hover, .btn-django-admin:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.admin-stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card h3 {
    font-size: 2rem;
    margin: 0;
}

.stat-card p {
    margin: 10px 0 0 0;
    font-size: 14px;
    opacity: 0.9;
}

.stat-card.total {
    background: linear-gradient(135deg, #4cd964 0%, #5ac8fa 100%);
}

.stat-card.recent {
    background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
}

.user-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.user-filters input, .user-filters select {
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 14px;
    min-width: 150px;
}

.user-filters input:focus, .user-filters select:focus {
    outline: none;
    border-color: #667eea;
}

.btn-refresh, .btn-clear-all {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-refresh {
    background: #4cd964;
    color: white;
}

.btn-clear-all {
    background: #ff4757;
    color: white;
}

.btn-refresh:hover, .btn-clear-all:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.admin-table-container {
    overflow-x: auto;
    margin-top: 20px;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table th {
    background: #667eea;
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    position: sticky;
    top: 0;
}

.admin-table td {
    padding: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.admin-table tr:hover {
    background: #f8f9fa;
}

.user-cell {
    display: flex;
    flex-direction: column;
}

.username {
    font-weight: 600;
}

.user-id {
    font-size: 12px;
    color: #666;
}

.operation-badge {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 600;
    color: white;
}

.operation-badge.add { background: #4cd964; }
.operation-badge.subtract { background: #ff6b6b; }
.operation-badge.multiply { background: #ffa502; }
.operation-badge.divide { background: #3742fa; }
.operation-badge.power { background: #a55eea; }
.operation-badge.sqrt { background: #20bf6b; }

.btn-delete, .btn-view {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 5px 10px;
    border-radius: 5px;
    transition: all 0.3s;
}

.btn-delete:hover {
    background: #ff4757;
    color: white;
}

.btn-view:hover {
    background: #667eea;
    color: white;
}

.loading, .empty {
    text-align: center;
    padding: 40px;
    color: #666;
}

.flash-message.error {
    background: #ff4757;
}

@media (max-width: 768px) {
    .user-filters {
        flex-direction: column;
    }
    
    .user-filters input, .user-filters select {
        width: 100%;
    }
    
    .admin-table {
        font-size: 14px;
    }
    
    .admin-table th, .admin-table td {
        padding: 10px;
    }
}
</style>
{% endblock %}